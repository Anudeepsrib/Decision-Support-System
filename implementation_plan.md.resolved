# Phase 4: Production-Grade ARR Truing-Up Engine

## Goal
Refactor the DSS from a demo prototype into an audit-ready system where every figure in the 30.06.2025 Order (Table 7.1) can be reconstructed with 100% mathematical fidelity. Split the architecture into **Brain** (Python/FastAPI) and **Body** (React/TypeScript).

## Proposed Changes

### System Blueprint & Architecture

#### [NEW] `backend/` — Python FastAPI (The Brain)
- Deterministic Rule Engine, OCR/Table extraction, ML Anomaly Detection.
- PostgreSQL for audited ARR heads; Redis for async job state.

#### [NEW] `frontend/` — React + TypeScript (The Body)
- Mapping Workbench UI where users verify AI-extracted numbers.
- Confirm/Override flow with mandatory comments.

---

### Canonical Schema & Database

#### [NEW] `backend/models/schema.py`
SQLAlchemy models: `ARRComponent`, `RuleSet`, `AuditTrail`, `MappingRecord`, `ExtractionEvidence`.

#### [NEW] `backend/engine/constants.py`
KSERC 2022-27 hard-coded regulatory constants (CPI:WPI 70:30, SBI EBLR + 2%, Gain/Loss 2/3:1/3).

---

### Deterministic Rule Engine

#### [NEW] `backend/engine/rule_engine.py`
Versioned Python class: Gain/Loss Sharing, O&M Normative escalation, Interest Logic.

---

### FastAPI PDF-to-Schema Bridge

#### [NEW] `backend/api/extraction.py`
`/extract` endpoint: PDF table extraction with page/table anchors.

#### [NEW] `backend/api/mapping.py`
`/mapping/confirm` endpoint: Human-in-the-loop confirmation flow.

#### [NEW] `backend/main.py`
FastAPI app entry point wiring all routes.

---

## Execution Order
1. System Blueprint (Mermaid) + directory structure.
2. Canonical Schema (SQLAlchemy models).
3. Rule Engine (Python class).
4. FastAPI endpoints (extraction + mapping).

## Verification Plan
- Run `uvicorn backend.main:app` to verify API boots.
- Validate schema models with `python -c "from backend.models.schema import *"`.
- Execute Rule Engine unit tests against known KSERC Order values.
